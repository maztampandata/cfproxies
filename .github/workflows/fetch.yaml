name: 🖥️ FETCH PROXY

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  split-proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Split by country + ALL (Python)
        run: |
          mkdir -p proxies
          # 🗑️ hapus file lama biar fresh
          rm -f proxies/*.txt || true
          python3 <<'EOF'
          import csv, os
          all_lines = []
          # 🔑 baca input dari backend/src/mazcheckproxy.txt
          with open("backend/src/mazcheckproxy.txt") as f:
              reader = csv.reader(f)
              for row in reader:
                  if len(row) < 3:
                      continue
                  all_lines.append(row)
                  country = row[2].strip()
                  path = f"proxies/{country}.txt"
                  # "w" mode = overwrite, bukan append
                  with open(path, "a") as out:
                      out.write(",".join(row) + "\n")
          # bikin file gabungan ALL.txt
          with open("proxies/ALL.txt", "w") as out_all:
              for row in all_lines:
                  out_all.write(",".join(row) + "\n")
          EOF

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proxies/*.txt
          git commit -m "Update proxy lists by country + ALL" || echo "No changes"
          git push origin main
